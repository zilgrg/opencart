<?php class gen_urls extends Controller { private $ssb_data;private $transliteration;private $seo_data=array();private $g_count =0;private $def_data=array( 'entity_cat' => '','entity_name'=> '','CPBI' => 'all','id_entity' => '','testgenerator'=> false );function __construct(){ global $registry;parent::__construct($registry);require_once DIR_CONFIG.'ssb_library/ssb_helper.php';$this->ssb_helper=ssb_helper::getInstance();require_once DIR_CONFIG.'ssb_library/admin/generators/gen_helper.php';$this->gen_helper=gen_helper::getInstance();require_once DIR_CONFIG.'ssb_library/admin/transliteration/transliteration.php';$this->transliteration=transliteration::getInstance();require_once DIR_CONFIG.'ssb_library/ssb_data.php';$this->ssb_data=ssb_data::getInstance();} static private $Instance =NULL;static public function getInstance() { if(self::$Instance==NULL){ $class=__CLASS__;self::$Instance=new $class;} return self::$Instance;} public function generate($data){ $time_start=microtime(true);$sql="UPDATE ".DB_PREFIX."setting SET `value` = '1' WHERE `group` = 'config' AND `key` = 'config_seo_url';";$this->db->query($sql);extract(array_merge($this->def_data,$data));$additionData=isset($additionData) ? $additionData:'';$res_count=0;$res_seo_data=array();if($entity_name !='STAN_urls'){ if($id_entity==''){ $CPBI=$entity_name=='CPBI_urls' ? 'all':$entity_name;} if($CPBI=='all'){ $CPBIs=$this->ssb_data->getMatadata('CPBI',array('keys'=>true));foreach($CPBIs as $CPBI){ $this->setVars_Common($entity_name,$CPBI,$testgenerator,$additionData,$pack);$this->doGenerate_CPBI_urls($CPBI,$id_entity);$res_count+=$this->g_count;$res_seo_data=array_merge($res_seo_data,$this->seo_data);} }else{ $pack=isset($pack) ? $pack:0;$this->setVars_Common($entity_name,$CPBI,$testgenerator,$additionData,$pack);$this->doGenerate_CPBI_urls($CPBI,$id_entity);$res_count =$this->g_count;$res_seo_data=$this->seo_data;} }else{ $this->setVars_Common($entity_name,$CPBI,$testgenerator);$this->doGenerate_STAN_urls($testgenerator);$res_count =$this->g_count;$res_seo_data=$this->seo_data;} $time_end=microtime(true);$time=$time_end-$time_start;return array('time'=> $time,'count'=> $res_count,'seo_data'=> $res_seo_data);} public function doGenerate_CPBI_urls($CPBI,$id_entity=''){ if($id_entity){ $CPBI_item=$this->ssb_data->getCPBI_item($CPBI,$id_entity);$CPBI_lang=$CPBI_item['data'][$id_entity];$meta_CPBI=$this->ssb_data->getMatadata('CPBI',array('val'=> 'db_name'));$db_name=$meta_CPBI[$CPBI];foreach($CPBI_lang as $l_code=> $val){ $language_id=$this->ssb_helper->getLang_Code_Id($l_code);if($this->isSeoUrl($db_name.'_id='.$id_entity,$language_id)){continue;} $status=$this->genProcess_CPBI_urls($l_code,$val,$id_entity,$CPBI);if($status OR $this->testgenerator){ $this->g_count++;} } }else{ $data_CPBI=$this->ssb_data->getCPBI('CPBI_urls','urls',$this->pack,$CPBI);$CPBI_data=$data_CPBI['data'];foreach($CPBI_data as $CPBI_id=> $CPBI_lang){ $this->setVars_CPBI_Process($CPBI);foreach($CPBI_lang as $l_code=> $val){ if(!isset($this->templates[$l_code]))continue;$status=$this->genProcess_CPBI_urls($l_code,$val,$CPBI_id,$CPBI);if($status OR $this->testgenerator){ $this->g_count++;} } if($this->testgenerator){ if($this->g_count>10)break;} } if($this->testgenerator){ $testData=array('CPBI'=> $CPBI);$this->endSeoData('CPBI_urls',$testData);} } } public function doGenerate_STAN_urls($testgenerator){ foreach($this->STAN_urls_data as $page_urls){ if($page_urls[1])$page_urls[1].=$this->STAN_urls_ext;$this->g_count++;if(!$testgenerator){ if($this->isSeoUrl($page_urls[0])){ $this->clearSeoUrl($page_urls[0]);} $this->saveSeoURL($page_urls[0],$page_urls[1],'STAN_urls');}else{ $testData=array( 'count'=> $this->g_count,'o_page'=> $page_urls[0],'n_page'=> $page_urls[1] );$this->fillSeoData('STAN_urls',$testData);} } $this->endSeoData('STAN_urls');} private function setVars_CPBI_Process($CPBI){ $setting_entities =$this->ssb_data->getSetting();$this->templates =$setting_entities['entity']['urls']['CPBI_urls']['data'][$CPBI]['data'];$this->templ_objs =$this->gen_helper->parseTemplate('',$CPBI,$this->templates);} private function setVars_Common($entity_name,$CPBI,$testgenerator,$additionData='',$pack=0){ $this->seo_data =array();$this->g_count =0;$this->testgenerator=$testgenerator;$this->pack =$pack;$setting =$this->ssb_data->getSetting();if($entity_name !='STAN_urls'){ $this->national_lang=isset($setting['entity']['urls']['CPBI_urls']['national_lang'])? $setting['entity']['urls']['CPBI_urls']['national_lang']:false;$this->CPBI_alias =$this->ssb_data->getMatadata('CPBI',array('val'=>'alias'));$meta_CPBI=$this->ssb_data->getMatadata('CPBI',array('val'=>'db_name'));$this->CPBI_db_name =$meta_CPBI[$CPBI];$this->CPBI_urls_ext=$setting['entity']['urls']['CPBI_urls']['ext'];$this->specialPatterns=$this->ssb_data->getPatterns('special');$this->condition=isset($additionData['condition']) ? $additionData['condition']:'';}else{ $this->STAN_urls_data=$setting['entity']['urls']['STAN_urls']['data'];$this->STAN_urls_ext=$setting['entity']['urls']['STAN_urls']['ext'];} } private function genProcess_CPBI_urls($l_code,$val,$CPBI_id,$CPBI){ $language_id=$this->ssb_helper->getLang_Code_Id($l_code);$query=$this->CPBI_db_name."_id=".$CPBI_id;$orig_name=$name=$val[$this->CPBI_alias[$CPBI]['name']];$replacinArr=$this->ssb_data->getReplacingArr('urls',$CPBI);if($this->templates[$l_code] !=''){ $name=$this->gen_helper->getSeoString( $this->templ_objs[$l_code],$this->templates[$l_code],$this->specialPatterns,$val,$CPBI,$l_code,'CPBI_urls',$replacinArr);}elseif(count($replacinArr)){ $param=array('product'=> 'pn','category'=> 'cn','brand'=> 'bn','info'=> 'in');$param=$param[$CPBI];if(is_array($replacinArr[$param])){ $search =$replacinArr[$param]['search'];$replace=$replacinArr[$param]['replace'];$name=str_replace($search,$replace,$name);} } $seoURL=$this->transliteration->get($name,$this->national_lang);$old_keyword=false;$CPBI_keyword=false;if($this->condition=='gen_only_for_empty'){ $sql="SELECT * FROM ".DB_PREFIX."url_alias WHERE query = '" . $query . "';";$exist_urls=$this->db->query($sql);foreach($exist_urls->rows as $exist_url){ if($exist_url['auto_gen']=='CPBI_urls'){ if($exist_url['language_id']==$language_id AND !$this->testgenerator){ return false;} }else{ $seoURL=$exist_url['keyword'];$sql="DELETE FROM ".DB_PREFIX."url_alias WHERE query = '" . $query . "' AND auto_gen <> 'CPBI_urls';";$this->db->query($sql);$old_keyword=true;} } } $seoURL_=($this->CPBI_db_name !='category' AND !$old_keyword) ? $seoURL.$this->CPBI_urls_ext:$seoURL;$sql="SELECT query FROM ".DB_PREFIX."url_alias WHERE keyword = '" . $seoURL_ . "' AND query <> '". $query . "'";$exist_seoURL=$this->db->query($sql);if($exist_seoURL->num_rows){$seoURL=$seoURL.'-'.$CPBI_id;} if($this->CPBI_db_name !='category' AND !$old_keyword){ if($seoURL)$seoURL.=$this->CPBI_urls_ext;} if(!$this->testgenerator){ $this->saveSeoURL($query,$seoURL,'CPBI_urls',$language_id);}else{ $testData=array( 'count'=> $this->g_count,'name'=> $orig_name,'seoURL'=> $seoURL,'l_code'=> $l_code,'CPBI' => $CPBI,);$this->fillSeoData('CPBI_urls',$testData);} if($old_keyword){ return false;}else{ return true;} } private function saveSeoURL($query,$keyword,$auto_gen,$language_id=''){ $sql_column=$language_id=='' ? "(query, keyword, auto_gen)":"(query, keyword, language_id, auto_gen)";$sql_value=$language_id=='' ? "('" . $query . "', '" . $keyword . "', 'STAN_urls')" :"('" . $query . "', '" . $keyword . "', ".$language_id.", 'CPBI_urls')";$sql="INSERT INTO ".DB_PREFIX."url_alias ".$sql_column." VALUES ".$sql_value;$insert_seoURL=$this->db->query($sql);} private function addTD($text,$attr=''){ return "<td ".$attr.">".$text."</td>";} private function fillSeoData($whom,$testData){ if($whom=='CPBI_urls'){ $this->seo_data[]="<tr>".$this->addTD($testData['count']).$this->addTD($testData['name']).$this->addTD($testData['seoURL']).$this->addTD($testData['l_code']) ."</tr>";}else{ $this->seo_data[]="<tr>".$this->addTD($testData['count']).$this->addTD($testData['o_page']).$this->addTD($testData['n_page']) ."</tr>";} } private function endSeoData($whom,$testData=''){ if($whom=='CPBI_urls'){ $language_text=$this->language->load('module/superseobox');$header='        <tr><td class="caption" colspan="4" >'.$language_text['text_entity_name_'.$testData['CPBI']].' pages:</td></tr>        <tr>         <th></th>         <th>Name</th>         <th>SEO URL</th>         <th>Language</th>        </tr>       ';$footer='<tr><th colspan="4">...etc.</th></tr>';}else{ $header=' <tr>         <th></th>         <th>Original URL</th>         <th>SEO URL</th>        </tr>      ';$footer='<tr><th colspan="3">...etc.</th></tr>';} array_unshift($this->seo_data,$header);$this->seo_data[]=$footer;} private function clearSeoUrl($query ){ $sql="DELETE FROM ".DB_PREFIX."url_alias WHERE query = '". $query ."'";$this->db->query($sql);} private function isSeoUrl($query,$language_id=''){ $addQuery='';if($language_id !=''){ $addQuery=" AND language_id=".(int)$language_id;} $sql="SELECT * FROM ".DB_PREFIX."url_alias WHERE query = '". $query ."'".$addQuery.";";$query=$this->db->query($sql);return count($query->rows);} }?>
