(function(a){function e(b,c,d){var e=document.selection.createRange();if(b==e.parentElement()){if(""==e.text){if(c){var f=e.getBookmark();e.moveStart("character",-d.tabString.length);if(d.tabString==e.text){e.text=""}else{e.moveToBookmark(f);e.moveEnd("character",d.tabString.length);if(d.tabString==e.text)e.text=""}e.collapse(true);e.select()}else{e.text=d.tabString;e.collapse(false);e.select()}}else{var g=e.text;var h=g.length;var i=g.split("\r\n");var j=document.body.createTextRange();j.moveToElementText(b);j.setEndPoint("EndToStart",e);var k=j.text;var l=k.split("\r\n");var m=k.length;var n=document.body.createTextRange();n.moveToElementText(b);n.setEndPoint("StartToEnd",e);var o=n.text;var p=document.body.createTextRange();p.moveToElementText(b);p.setEndPoint("StartToEnd",j);var q=p.text;var r=a(b).html();a("#r3").text(m+" + "+h+" + "+o.length+" = "+r.length);if(m+q.length<r.length){l.push("");m+=2;if(c&&d.tabString==i[0].substring(0,d.tabString.length))i[0]=i[0].substring(d.tabString.length);else if(!c)i[0]=d.tabString+i[0]}else{if(c&&d.tabString==l[l.length-1].substring(0,d.tabString.length))l[l.length-1]=l[l.length-1].substring(d.tabString.length);else if(!c)l[l.length-1]=d.tabString+l[l.length-1]}for(var s=1;s<i.length;s++){if(c&&d.tabString==i[s].substring(0,d.tabString.length))i[s]=i[s].substring(d.tabString.length);else if(!c)i[s]=d.tabString+i[s]}if(1==l.length&&0==m){if(c&&d.tabString==i[0].substring(0,d.tabString.length))i[0]=i[0].substring(d.tabString.length);else if(!c)i[0]=d.tabString+i[0]}if(m+h+o.length<r.length){i.push("");h+=2}j.text=l.join("\r\n");e.text=i.join("\r\n");var t=document.body.createTextRange();t.moveToElementText(b);if(0<m)t.setEndPoint("StartToEnd",j);else t.setEndPoint("StartToStart",j);t.setEndPoint("EndToEnd",e);t.select()}}}function d(a,b,c){var d=a.selectionStart;var e=a.selectionEnd;if(d==e){if(b){if("\t"==a.value.substring(d-c.tabString.length,d)){a.value=a.value.substring(0,d-c.tabString.length)+a.value.substring(d);a.focus();a.setSelectionRange(d-c.tabString.length,d-c.tabString.length)}else if("\t"==a.value.substring(d,d+c.tabString.length)){a.value=a.value.substring(0,d)+a.value.substring(d+c.tabString.length);a.focus();a.setSelectionRange(d,d)}}else{a.value=a.value.substring(0,d)+c.tabString+a.value.substring(d);a.focus();a.setSelectionRange(d+c.tabString.length,d+c.tabString.length)}}else{var f=a.value.split("\n");var g=new Array;var h=0;var i=0;var j=false;for(var k in f){i=h+f[k].length;g.push({start:h,end:i,selected:h<=d&&i>d||i>=e&&h<e||h>d&&i<e});h=i+1}var l=0;for(var k in g){if(g[k].selected){var m=g[k].start+l;if(b&&c.tabString==a.value.substring(m,m+c.tabString.length)){a.value=a.value.substring(0,m)+a.value.substring(m+c.tabString.length);l-=c.tabString.length}else if(!b){a.value=a.value.substring(0,m)+c.tabString+a.value.substring(m);l+=c.tabString.length}}}a.focus();var n=d+(l>0?c.tabString.length:l<0?-c.tabString.length:0);var o=e+l;a.setSelectionRange(n,o)}}function c(a,b,c){var f=a.scrollTop;if(a.setSelectionRange)d(a,b,c);else if(document.selection)e(a,b,c);a.scrollTop=f}function b(a){if(window.console&&window.console.log)window.console.log("textarea count: "+a.size())}a.fn.tabby=function(b){var d=a.extend({},a.fn.tabby.defaults,b);var e=a.fn.tabby.pressed;return this.each(function(){$this=a(this);var b=a.meta?a.extend({},d,$this.data()):d;$this.bind("keydown",function(d){var f=a.fn.tabby.catch_kc(d);if(16==f)e.shft=true;if(17==f){e.ctrl=true;setTimeout("$.fn.tabby.pressed.ctrl = false;",1e3)}if(18==f){e.alt=true;setTimeout("$.fn.tabby.pressed.alt = false;",1e3)}if(9==f&&!e.ctrl&&!e.alt){d.preventDefault;e.last=f;setTimeout("$.fn.tabby.pressed.last = null;",0);c(a(d.target).get(0),e.shft,b);return false}}).bind("keyup",function(b){if(16==a.fn.tabby.catch_kc(b))e.shft=false}).bind("blur",function(b){if(9==e.last)a(b.target).one("focus",function(a){e.last=null}).get(0).focus()})})};a.fn.tabby.catch_kc=function(a){return a.keyCode?a.keyCode:a.charCode?a.charCode:a.which};a.fn.tabby.pressed={shft:false,ctrl:false,alt:false,last:null};a.fn.tabby.defaults={tabString:String.fromCharCode(9)}})(jQuery)